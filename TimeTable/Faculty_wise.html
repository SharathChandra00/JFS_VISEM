<!DOCTYPE html>
<html>
<head>
    <title>Faculty-wise Timetable</title>

    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        table {
            width: 80%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background: lightblue;
        }
        .faculty-title {
            font-weight: bold;
            font-size: 20px;
            margin-top: 30px;
        }
        button {
            margin-bottom: 10px;
            padding: 6px 12px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<h2>Upload CSV File</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="tables"></div>

<script>
/* ===============================
   CSV FILE UPLOAD HANDLER
================================ */
document.getElementById("csvFile").addEventListener("change", function () {
    Papa.parse(this.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function (result) {
            processCSV(result.data);
        }
    });
});

/* ===============================
   PROCESS CSV DATA
   GROUP BY FACULTY
================================ */
function processCSV(data) {

    /*
      timetable structure:
      {
        FacultyName: {
            MON: { FN: "...", AN: "..." },
            TUE: { FN: "...", AN: "..." }
        }
      }
    */

    const timetable = {};

    data.forEach(row => {
        const faculty = row["FACULTY"];
        const day = row["DAY"];
        const session = row["SESSION"];   // FN / AN
        const course = row["COURSE"];
        const room = row["ROOM"];
        const batch = row["BATCH"];

        if (!faculty || !day || !session) return;

        if (!timetable[faculty]) {
            timetable[faculty] = {};
        }

        if (!timetable[faculty][day]) {
            timetable[faculty][day] = { FN: "", AN: "" };
        }

        // Store course + batch + room
        timetable[faculty][day][session] =
            course +
            "<br>Batch: " + batch +
            "<br>Room: " + room;
    });

    buildTables(timetable);
}

/* ===============================
   BUILD FACULTY TABLES
================================ */
function buildTables(timetable) {

    const container = document.getElementById("tables");
    container.innerHTML = "";

    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];

    for (const faculty in timetable) {

        /* Wrapper */
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "40px";

        /* Faculty Title */
        const title = document.createElement("div");
        title.className = "faculty-title";
        title.innerHTML = "Faculty: " + faculty;

        /* Print Button */
        const btn = document.createElement("button");
        btn.innerHTML = "Print This Timetable";
        btn.onclick = function () {
            printTable(faculty);
        };

        /* Table */
        const table = document.createElement("table");
        table.id = "table_" + faculty.replace(/\s+/g, "_");

        let html =
            "<tr>" +
            "<th>DAY</th>" +
            "<th>FN</th>" +
            "<th rowspan='7'>L<br>U<br>N<br>C<br>H</th>" +
            "<th>AN</th>" +
            "</tr>";

        days.forEach(day => {
            const fn = timetable[faculty][day]?.FN || "";
            const an = timetable[faculty][day]?.AN || "";

            html +=
                "<tr>" +
                "<td>" + day + "</td>" +
                "<td>" + fn + "</td>" +
                "<td>" + an + "</td>" +
                "</tr>";
        });

        table.innerHTML = html;

        wrapper.appendChild(title);
        wrapper.appendChild(btn);
        wrapper.appendChild(table);
        container.appendChild(wrapper);
    }
}

/* ===============================
   PRINT FACULTY TIMETABLE
================================ */
function printTable(faculty) {

    const tableId = "table_" + faculty.replace(/\s+/g, "_");
    const tableHTML = document.getElementById(tableId).outerHTML;
    const title = "<h2>Faculty: " + faculty + "</h2>";

    const printWindow = window.open("", "", "width=900,height=600");

    printWindow.document.open();
    printWindow.document.write(
        "<html>" +
        "<head>" +
        "<title>Print Timetable</title>" +
        "<style>" +
        "table{width:100%;border-collapse:collapse;}" +
        "th,td{border:1px solid black;padding:8px;text-align:center;}" +
        "th{background:lightblue;}" +
        "</style>" +
        "</head>" +
        "<body>" +
        title +
        tableHTML +
        "</body>" +
        "</html>"
    );

    printWindow.document.close();
    printWindow.print();
}

/* ======================================================
   OLD BATCH-WISE FUNCTION (REFERENCE ONLY)
======================================================

function buildTables(timetable) {
    ...
}

*/
</script>

</body>
</html>
